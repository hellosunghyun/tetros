# ==============================================================================
# 테트로스 (TetrOS) 빌드 시스템
# ==============================================================================
# 이 Makefile은 테트로스 부트섹터 게임을 빌드하고 실행하는 데 사용됩니다.
# NASM 어셈블러를 사용하여 .asm 파일을 바이너리 부트 이미지로 컴파일합니다.
# ==============================================================================

# ------------------------------------------------------------------------------
# 운영체제 감지 및 도구 설정
# ------------------------------------------------------------------------------
# macOS와 Linux에서 서로 다른 stat 명령어 사용
# macOS: GNU coreutils의 gstat 필요 (brew install coreutils)
# Linux: 기본 stat 명령어 사용
# ------------------------------------------------------------------------------
UNAME := $(shell uname)          # 현재 운영체제 이름 감지
ifeq ($(UNAME), Darwin)          # macOS인 경우
	STAT := gstat                # GNU stat 사용 (macOS의 stat은 옵션이 다름)
else                             # Linux 또는 기타 Unix인 경우
	STAT := stat                 # 표준 stat 명령어 사용
endif

# ------------------------------------------------------------------------------
# 기본 타겟: all
# ------------------------------------------------------------------------------
# 'make' 또는 'make all' 실행 시 tetros.img 빌드
# ------------------------------------------------------------------------------
all: tetros.img

# ------------------------------------------------------------------------------
# 빌드 규칙: tetros.img
# ------------------------------------------------------------------------------
# tetros.asm과 Makefile이 변경되면 부트 이미지를 다시 빌드
#
# 빌드 과정:
# 1. DEBUG 플래그로 먼저 빌드하여 코드 크기 확인
# 2. 446바이트 초과 시 오류 출력 후 실패
# 3. 크기 검증 통과 시 릴리스 빌드 수행
#
# 왜 446바이트인가?
# - 부트섹터는 총 512바이트
# - 바이트 446-509: 파티션 테이블 (64바이트)
# - 바이트 510-511: 부트 시그니처 (0x55, 0xAA)
# - 따라서 실제 코드는 446바이트 이내여야 함
# ------------------------------------------------------------------------------
tetros.img: tetros.asm Makefile
	# DEBUG 모드로 빌드 (크기 제한 없이 전체 코드 컴파일)
	nasm -d DEBUG -f bin tetros.asm -o tetros.img
	# 빌드된 파일 크기 출력
	@echo "size is" `$(STAT) -c "%s" tetros.img`
	# 446바이트 초과 시 오류 메시지 출력 후 빌드 실패
	@if [ `$(STAT) -c "%s" tetros.img` -gt 446 ]; then \
		bash -c 'echo -e "\e[91mOutput exceeded size of 446 bytes.\e[0m"'; \
		rm -f tetros.img; exit 1; fi
	# 크기 검증 통과 후 릴리스 빌드 (파티션 테이블과 부트 시그니처 포함)
	nasm -f bin tetros.asm -o tetros.img

# ------------------------------------------------------------------------------
# 실행 타겟: run
# ------------------------------------------------------------------------------
# QEMU 에뮬레이터를 사용하여 테트로스 게임 실행
#
# QEMU 옵션 설명:
# - qemu-system-i386: 32비트 x86 시스템 에뮬레이션
# - -drive file=...: 디스크 이미지 파일 지정
# - index=0: 첫 번째 드라이브 (부팅 드라이브)
# - media=disk: 하드 디스크로 취급
# - format=raw: 원시 바이너리 형식 (파티션/파일시스템 없음)
# ------------------------------------------------------------------------------
run: tetros.img
	@qemu-system-i386 -drive file=tetros.img,index=0,media=disk,format=raw

# ------------------------------------------------------------------------------
# 정리 타겟: clean
# ------------------------------------------------------------------------------
# 빌드된 파일 삭제 (빌드 이전 상태로 복원)
# ------------------------------------------------------------------------------
clean:
	rm -f tetros.img               # 부트 이미지 파일 삭제
